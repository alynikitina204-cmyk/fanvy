<!DOCTYPE html>
<html>
<head>
    <title>{{ user.username }} ‚Ä¢ Profile</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        /* VIP Badge Styles */
        .vip-badge {
            display:inline-block;
            padding:2px 8px;
            border-radius:6px;
            font-size:11px;
            font-weight:700;
            margin-left:6px;
            text-transform:uppercase;
        }
        .vip-pink { background:linear-gradient(135deg, #ff6ec4, #ff9a9e); color:#fff; }
        .vip-gold { background:linear-gradient(135deg, #ffd700, #ffed4e); color:#333; }
        .vip-blue { background:linear-gradient(135deg, #667eea, #764ba2); color:#fff; }
        .vip-purple { background:linear-gradient(135deg, #a8edea, #fed6e3); color:#333; }
        .vip-green { background:linear-gradient(135deg, #11998e, #38ef7d); color:#fff; }
        
        .edit-modal{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.45);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:999;
        }

        .edit-card{
            background:var(--card);
            padding:22px;
            border-radius:18px;
            width:340px;
            box-shadow:var(--shadow-medium);
            border:1px solid var(--border-soft);
        }

        .edit-card textarea{
            width:100%;
            min-height:90px;
            margin-bottom:12px;
            padding:10px;
            border-radius:12px;
            border:1px solid var(--border-soft);
            background:var(--soft-1);
            color:var(--text);
        }

        .edit-actions{
            display:flex;
            justify-content:flex-end;
            gap:10px;
        }

        .album-grid img{
            border-radius:12px;
            object-fit:cover;
            width:100%;
            height:160px;
        }

        /* Notification badge */
        .notification-badge {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            display: inline-block;
        }
        .sidebar a {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Modern textarea for post bar */
        .post-bar-textarea {
            width:100%;
            min-height:80px;
            border-radius:16px;
            border:1.5px solid var(--border-soft);
            padding:14px;
            font-size:16px;
            background:var(--soft-1);
            margin-bottom:14px;
            box-shadow:0 2px 8px rgba(0,0,0,.04);
            transition:border .2s;
        }
        .post-bar-textarea:focus {
            border-color:var(--border);
            outline:none;
        }

        .custom-file {
            display:inline-block;
            position:relative;
            margin-right:10px;
        }
        .custom-file input[type="file"] {
            display:none;
        }
        .custom-file-label {
            display:inline-block;
            background:#fff;
            color:var(--text);
            padding:10px 22px;
            border-radius:50px;
            cursor:pointer;
            font-weight:500;
            margin-bottom:8px;
            box-shadow:var(--shadow-soft);
            border:1px solid var(--border-soft);
            transition:box-shadow .2s, border .2s;
        }
        .custom-file-label:active,
        .custom-file-label:focus {
            box-shadow:var(--shadow-medium);
            border:1.5px solid var(--border);
        }
        .edit-btn {
            background:#fff;
            color:var(--text);
            border:1px solid var(--border);
            padding:10px 22px;
            border-radius:50px;
            font-weight:500;
            cursor:pointer;
            box-shadow:var(--shadow-soft);
            transition:box-shadow .2s, border .2s;
        }
        .edit-btn:active,
        .edit-btn:focus {
            box-shadow:var(--shadow-medium);
            border:1.5px solid var(--border);
        }

        .profile-story {
            display:flex;
            align-items:center;
            gap:14px;
            margin:14px 0 6px;
        }
        .story-ring {
            position:relative;
            width:74px;
            height:74px;
            border-radius:50%;
            padding:3px;
            background: var(--soft-2);
            border:1.5px solid var(--border-soft);
            cursor:pointer;
            box-shadow: var(--shadow-soft);
        }
        .story-ring.has-story {
            border-color: var(--border);
        }
        .story-ring img {
            width:100%;
            height:100%;
            border-radius:50%;
            object-fit:cover;
            background: var(--soft-1);
        }
        .story-add {
            position:absolute;
            bottom:-2px;
            right:-2px;
            width:22px;
            height:22px;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            background: #fff;
            border:1px solid var(--border);
            color: var(--text);
            font-size:12px;
            box-shadow: var(--shadow-soft);
        }
        .story-title { font-weight:600; }
        .story-sub { color: var(--muted); font-size: 13px; }

        body.profile-story-open { overflow: hidden; }
        body.profile-story-open #themeToggle { display: none; }

        .profile-story-modal {
            position: fixed;
            inset: 0;
            display: none;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
        }
        .profile-story-shell {
            width: min(520px, 92vw);
            background: rgba(12,12,12,0.9);
            border-radius: 18px;
            padding: 14px 14px 10px;
            color: #fff;
            box-shadow: 0 24px 80px rgba(0,0,0,.35);
        }
        .profile-story-top {
            display:flex;
            flex-direction:column;
            align-items:flex-start;
            gap:8px;
            margin-bottom:10px;
        }
        .profile-story-userline {
            display:flex;
            align-items:center;
            gap:8px;
            font-weight:600;
            font-size:14px;
        }
        .profile-story-pfp {
            width:32px;
            height:32px;
            border-radius:50%;
            object-fit:cover;
            border:1px solid rgba(255,255,255,.2);
        }
        .profile-story-actions {
            display:flex;
            align-items:center;
            gap:8px;
            margin-left:40px;
        }
        .profile-story-icon {
            background: rgba(255,255,255,.12);
            border: 1px solid rgba(255,255,255,.12);
            color: #fff;
            width:32px;
            height:32px;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
        }
        .profile-story-icon:hover { background: rgba(255,255,255,.22); }
        .profile-story-icon.danger { background: rgba(220,38,38,.2); border-color: rgba(220,38,38,.45); }

        .profile-story-media {
            position: relative;
            border-radius: 14px;
            overflow: hidden;
            background: #000;
        }
        .profile-story-full {
            width: 100%;
            height: auto;
            max-height: 70vh;
            object-fit: contain;
            display:block;
        }
        .profile-story-nav {
            position:absolute;
            top:50%;
            transform:translateY(-50%);
            background: rgba(0,0,0,0.35);
            border:none;
            color:#fff;
            font-size:20px;
            padding:6px 10px;
            cursor:pointer;
            border-radius:999px;
            z-index:1001;
            opacity:0.6;
        }
        .profile-story-nav.prev { left:8px; }
        .profile-story-nav.next { right:8px; }
        .profile-story-nav:hover { background: rgba(0,0,0,0.55); opacity:0.9; }

        /* Image Lightbox */
        .image-lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            cursor: zoom-out;
        }
        .image-lightbox img {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .lightbox-actions {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 2001;
        }
        .lightbox-btn {
            color: white;
            font-size: 16px;
            cursor: pointer;
            background: rgba(255,255,255,0.15);
            padding: 12px 24px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .lightbox-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        .lightbox-btn.delete {
            background: rgba(239,68,68,0.2);
            border-color: rgba(239,68,68,0.4);
        }
        .lightbox-btn.delete:hover {
            background: rgba(239,68,68,0.35);
        }
        .album-grid img, .post-image {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .album-grid img:hover, .post-image:hover {
            transform: scale(1.02);
        }
        
        .followers-stats-box {
            transition: all .2s;
        }
        .followers-stats-box:hover {
            background: var(--card) !important;
            box-shadow: var(--shadow-medium);
            border-color: var(--border) !important;
        }
    </style>
</head>

<body>
{% include '_theme_toggle.html' %}

<div class="container">

<!-- Sidebar -->
<div class="sidebar">
    <h3>Hi {{ session.username }}</h3>
    <a href="/forum">Community</a>
    <a href="/friends">
        <span>Friends</span>
        {% if friend_requests_count > 0 %}
        <span class="notification-badge">{{ friend_requests_count }}</span>
        {% endif %}
    </a>
    <a href="/followers">
        <span>Followers</span>
        {% if new_followers_count > 0 %}
        <span class="notification-badge">{{ new_followers_count }}</span>
        {% endif %}
    </a>
    <a href="/messages">
        <span>Messages</span>
        {% if unread_messages_count > 0 %}
        <span class="notification-badge">{{ unread_messages_count }}</span>
        {% endif %}
    </a>
    <a href="/profile">Profile</a>
    <a href="/photos">Photos</a>
    <a href="/watch">Watch Together</a>
    {% if session.user_id == 1 %}
    <a href="/shop">Shop</a>
    <a href="/purchases">My Purchases</a>
    {% endif %}
    <a href="/subscription">Subscription</a>
    <a href="/dashboard">Dashboard</a>
</div>

<div class="feed">

<!-- PROFILE HEADER -->
<div class="profile-header" style="position:relative;">
    <img src="{{ url_for('static', filename=user.avatar or 'avatars/default.png') }}?t={{ range(1, 999999) | random }}">
    <div>
        <h2>{{ user.username }} {{ user.id | online_status }}
            {% if user.id == 1 %}
                <span class="admin-badge">ADMIN</span>
            {% elif user.badge and user.badge != 'none' %}
                <span class="vip-badge {{ user.badge }}">VIP</span>
            {% endif %}
            {% if user.verified %}
                <span class="verified-badge">&#10003;</span>
            {% endif %}
        </h2>
        <p style="color:#888;font-size:14px;margin:-4px 0 8px 0;">@{{ user.handle or user.username|lower }}</p>
        <p>{{ user.bio or "No bio yet" }}</p>
        {% if user.interests %}
        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;">
            {% for interest in user.interests.split(',') %}
            {% if interest.strip() %}
            <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">#{{ interest.strip() }}</span>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    {% if user.subscription in ['basic', 'pro', 'premium'] %}
    <a href="/followers" style="position:absolute;top:20px;right:120px;text-decoration:none;color:inherit;">
        <div class="followers-stats-box" style="display:flex;gap:25px;font-size:14px;cursor:pointer;padding:12px 20px;background:var(--soft-1);border-radius:14px;border:1px solid var(--border-soft);">
            <div style="text-align:center;">
                <div style="font-weight:700;color:var(--text);font-size:20px;">{{ follower_count if not user.hide_followers else '‚Ä¢‚Ä¢' }}</div>
                <div style="color:#888;font-size:12px;margin-top:2px;">Followers</div>
            </div>
            <div style="text-align:center;">
                <div style="font-weight:700;color:var(--text);font-size:20px;">{{ following_count }}</div>
                <div style="color:#888;font-size:12px;margin-top:2px;">Following</div>
            </div>
        </div>
    </a>
    {% endif %}
    
    <button class="edit-btn" onclick="openEdit()" style="position:absolute;top:20px;right:20px;">Edit</button>
</div>

<!-- STORY -->
<div class="profile-story">
    <div class="story-ring {% if stories %}has-story{% endif %}" onclick="openMyStory()">
        <img src="{{ url_for('static', filename=user.avatar or 'avatars/default.png') }}?t={{ range(1, 999999) | random }}">
        <label class="story-add" for="profileStoryInput" onclick="event.stopPropagation();" title="Add Story">
            <i class="fa-solid fa-plus"></i>
        </label>
    </div>
    <div>
        <div class="story-title">Your Story</div>
        <div class="story-sub">Tap to view, + to add</div>
    </div>
    <form class="story-upload-form" method="POST" action="/add_story?next=/profile" enctype="multipart/form-data" style="display:inline;">
        <input id="profileStoryInput" type="file" name="image" accept="image/*" style="display:none;" onchange="this.form.submit()">
    </form>
</div>

<!-- EDIT MODAL -->
<div class="edit-modal" id="editModal">
    <div class="edit-card">
        <h3>Edit Profile</h3>
        <form method="POST" action="/profile" enctype="multipart/form-data">
            {% if user.subscription == 'premium' %}
            <label style="display:block;margin-bottom:4px;font-size:14px;color:var(--text);">Display Name</label>
            <input type="text" name="username" value="{{ user.username }}" placeholder="Display Name" style="width:100%;margin-bottom:12px;padding:10px;border-radius:12px;border:1px solid var(--border-soft);background:var(--soft-1);color:var(--text);">
            <p style="font-size:12px;color:#888;margin:-8px 0 12px 0;">Your permanent ID: @{{ user.handle or user.username|lower }}</p>
            
            <label style="display:block;margin-bottom:6px;font-size:14px;color:var(--text);">VIP Badge Style</label>
            <select name="badge" style="width:100%;margin-bottom:12px;padding:10px;border-radius:12px;border:1px solid var(--border-soft);background:var(--soft-1);color:var(--text);">
                <option value="none" {% if not user.badge or user.badge == 'none' %}selected{% endif %}>No Badge</option>
                <option value="vip_pink" {% if user.badge == 'vip_pink' %}selected{% endif %}>üíñ VIP Pink</option>
                <option value="vip_gold" {% if user.badge == 'vip_gold' %}selected{% endif %}>‚≠ê VIP Gold</option>
                <option value="vip_blue" {% if user.badge == 'vip_blue' %}selected{% endif %}>üíé VIP Blue</option>
                <option value="vip_purple" {% if user.badge == 'vip_purple' %}selected{% endif %}>ü¶Ñ VIP Purple</option>
                <option value="vip_green" {% if user.badge == 'vip_green' %}selected{% endif %}>üíö VIP Green</option>
            </select>

            <div style="margin-bottom:12px;padding:12px;background:var(--soft-1);border-radius:12px;border:1px solid var(--border-soft);">
                <label style="display:flex;align-items:center;margin-bottom:10px;cursor:pointer;font-size:14px;color:var(--text);">
                    <input type="checkbox" name="is_private" {% if user.is_private %}checked{% endif %} style="margin-right:8px;width:18px;height:18px;cursor:pointer;">
                    <span>üîí Make Account Private</span>
                </label>
                <p style="font-size:12px;color:#888;margin:0 0 8px 26px;">Only friends can see your profile</p>

                <label style="display:flex;align-items:center;cursor:pointer;font-size:14px;color:var(--text);">
                    <input type="checkbox" name="allow_messages" checked {% if not user.allow_messages %}{% endif %} style="margin-right:8px;width:18px;height:18px;cursor:pointer;">
                    <span>üí¨ Allow Direct Messages</span>
                </label>
                <p style="font-size:12px;color:#888;margin:0 0 8px 26px;">Users can send you messages</p>

                <label style="display:flex;align-items:center;cursor:pointer;font-size:14px;color:var(--text);">
                    <input type="checkbox" name="hide_followers" {% if user.hide_followers %}checked{% endif %} style="margin-right:8px;width:18px;height:18px;cursor:pointer;">
                    <span>üëÅÔ∏è Hide Follower Count</span>
                </label>
                <p style="font-size:12px;color:#888;margin:0 0 0 26px;">Only you can see your follower count</p>
            </div>
            {% endif %}
            
            <label style="display:block;margin-bottom:4px;font-size:14px;color:var(--text);">Bio</label>
            <textarea name="bio" placeholder="Bio">{{ user.bio }}</textarea>
            
            <label style="display:block;margin-bottom:4px;margin-top:12px;font-size:14px;color:var(--text);">Interests <span style="font-size:11px;color:#888;">(comma separated)</span></label>
            <input type="text" name="interests" placeholder="e.g. music, gaming, travel, photography" value="{{ user.interests or '' }}" style="margin-bottom:12px;padding:10px;width:100%;border:1px solid var(--border-soft);border-radius:8px;background:var(--soft-1);font-size:14px;">
            
            <label style="display:block;margin-bottom:6px;font-size:14px;color:var(--text);">Profile Picture</label>
            <input type="file" name="avatar" accept="image/*" style="margin-bottom:12px;padding:8px;width:100%;border:1px solid var(--border-soft);border-radius:8px;background:var(--soft-1);">

            <div class="edit-actions">
                <button type="submit" class="edit-btn">Save</button>
                <button type="button" class="edit-btn" onclick="closeEdit()">Cancel</button>
            </div>
        </form>
        
        <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border-soft);">
            <button type="button" onclick="confirmDeleteAccount()" class="edit-btn" style="width:100%;background:var(--soft-1);color:var(--muted);border-color:var(--border-soft);">
                <i class="fa-solid fa-trash" style="margin-right:6px;"></i> Delete Account
            </button>
            <p style="font-size:12px;color:#888;margin:8px 0 0 0;text-align:center;">This action cannot be undone</p>
        </div>
    </div>
</div>

<!-- ALBUM -->
<div class="album-header">
    <h3>Your Album</h3>
    <button class="edit-btn" onclick="toggleAlbum()">Add</button>
</div>

<div id="albumUpload" style="display:none;margin-top:10px;">
    <form method="POST" action="/add_album_image" enctype="multipart/form-data">
        <input type="file" name="image" accept="image/*" required>
        <input type="text" name="caption" placeholder="Caption (optional)" style="margin-top:8px;margin-bottom:8px;width:70%;padding:8px;border-radius:10px;border:1px solid var(--border-soft);background:var(--soft-1);color:var(--text);">
        <button class="edit-btn">Upload</button>
    </form>
</div>

<div class="album-grid">
{% for img in album_images %}
    <div style="margin-bottom:12px;">
        <img src="{{ url_for('static', filename=img.image) }}" onclick="openLightbox(this.src, 'album', {{ img.id }})">
        {% if img.caption %}
        <div style="padding:6px 0;color:#888;font-size:14px;text-align:center;">{{ img.caption }}</div>
        {% endif %}
    </div>
{% endfor %}
</div>

<!-- POST BAR -->
<div class="story-bar feed">
    <form id="profilePostForm" method="POST" action="/profile/post" enctype="multipart/form-data">
        <textarea class="post-bar-textarea" name="content" placeholder="Write something..."></textarea>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px;flex-wrap:wrap;">
            <div>
                <label for="profileImageInput" class="chat-upload-label" title="Add Image" style="cursor:pointer;">
                    <i class="fa-regular fa-image chat-upload-icon"></i>
                </label>
                <input type="file" name="image" accept="image/*" style="display:none;" id="profileImageInput">
                <span id="profileImageName" style="font-size:12px;color:#888;margin-left:4px;"></span>
            </div>
            {% if user.subscription == 'premium' %}
            <div>
                <label for="profileMusicInput" class="chat-upload-label" title="Add Music" style="cursor:pointer;">
                    <i class="fa-solid fa-music chat-upload-icon"></i>
                </label>
                <input type="file" name="music" accept="audio/*" style="display:none;" id="profileMusicInput">
                <span id="profileMusicName" style="font-size:12px;color:#888;margin-left:4px;"></span>
            </div>
            {% endif %}
        </div>
        <button class="edit-btn" type="submit">Post</button>
    </form>
</div>

<script>
const profileImageInput = document.getElementById('profileImageInput');
const profileMusicInput = document.getElementById('profileMusicInput');

if(profileImageInput) {
    profileImageInput.addEventListener('change', (e) => {
        const name = e.target.files.length > 0 ? '‚úì ' + e.target.files[0].name : '';
        document.getElementById('profileImageName').textContent = name;
        console.log('Profile image selected:', e.target.files[0]?.name);
    });
}

if(profileMusicInput) {
    profileMusicInput.addEventListener('change', (e) => {
        const name = e.target.files.length > 0 ? '‚úì ' + e.target.files[0].name : '';
        document.getElementById('profileMusicName').textContent = name;
        console.log('Profile music selected:', e.target.files[0]?.name);
    });
}
</script>

<!-- POSTS -->
{% if posts %}
{% for post in posts %}
<div class="post-card">
    <div class="post-header">
        <img src="{{ url_for('static', filename=post.avatar or 'avatars/default.png') }}?t={{ range(1, 999999) | random }}">
        <div>
            <a href="/user/{{ post.user_id }}" class="username">
                {{ post.username }} {{ post.user_id | online_status }}
                {% if post.user_id == 1 %}
                    <span class="admin-badge">ADMIN</span>
                {% elif post.user_badge and post.user_badge != 'none' %}
                    <span class="vip-badge {{ post.user_badge }}">VIP</span>
                {% endif %}
            </a><br>
            <small>{{ post.created_at }}</small>
        </div>
    </div>

    {% if post.content %}
    <div class="post-content">{{ post.content | linkify }}</div>
    {% endif %}

    {% if post.image %}
        <img src="{{ url_for('static', filename=post.image) }}" class="post-image" onclick="openLightbox(this.src, 'post', {{ post.id }})">
    {% endif %}

    {% if post.music %}
    <div class="music-post" style="display:flex;align-items:center;gap:8px;padding:0;margin-top:8px;background:transparent;">
        <i class="fa-solid fa-music" style="font-size:18px;color:#bbb;"></i>
        <div style="flex:1;display:flex;flex-direction:column;gap:4px;">
            {% if post.music_title %}
            <span style="font-size:13px;color:var(--text);font-weight:500;">{{ post.music_title }}</span>
            {% endif %}
            <audio controls src="{{ url_for('static', filename=post.music) }}" style="flex:1;background:transparent;height:28px;"></audio>
        </div>
    </div>
    {% endif %}

    <form method="POST" action="/profile/post/{{ post.id }}/delete">
        <button class="delete-btn">Delete</button>
    </form>
</div>
{% endfor %}
{% else %}
<div style="padding:20px;text-align:center;background:var(--soft-1);border-radius:12px;border:1px solid var(--border-soft);color:var(--muted);">
    <i class="fa-regular fa-image" style="font-size:32px;display:block;margin-bottom:8px;"></i>
    No posts yet. Create your first post above! üìù
</div>
{% endif %}

</div>
</div>

<!-- Image Lightbox -->
<div id="imageLightbox" class="image-lightbox" onclick="closeLightbox()">
    <img id="lightboxImage" src="" onclick="event.stopPropagation()" data-type="" data-id="">
    <div class="lightbox-actions" onclick="event.stopPropagation()">
        <button class="lightbox-btn" onclick="closeLightbox()">
            <i class="fa-solid fa-xmark"></i> Close
        </button>
        <button class="lightbox-btn delete" onclick="deleteLightboxImage()">
            <i class="fa-solid fa-trash"></i> Delete
        </button>
    </div>
</div>

<div id="profileStoryModal" class="profile-story-modal">
    <div class="profile-story-shell">
        <div class="profile-story-top">
            <div class="profile-story-userline">
                <img id="profileStoryPfp" src="" class="profile-story-pfp">
                <span id="profileStoryUsername"></span>
            </div>
            <div class="profile-story-actions">
                <button id="profileStoryBack" class="profile-story-icon" type="button" title="Back">
                    <i class="fa fa-arrow-left"></i>
                </button>
                <button id="profileStoryDelete" class="profile-story-icon danger" type="button" title="Delete">
                    <i class="fa fa-trash"></i>
                </button>
            </div>
        </div>

        <div class="profile-story-media">
            <button class="profile-story-nav prev" onclick="profilePrevStory()">&#10094;</button>
            <img id="profileStoryImage" class="profile-story-full">
            <button class="profile-story-nav next" onclick="profileNextStory()">&#10095;</button>
        </div>
    </div>
</div>

<script>
function openEdit(){
    document.getElementById('editModal').style.display = 'flex';
}

function closeEdit(){
    document.getElementById('editModal').style.display = 'none';
}

function toggleAlbum(){
    let box = document.getElementById('albumUpload');
    box.style.display = box.style.display === 'block' ? 'none' : 'block';
}

function openLightbox(imgSrc, type, id) {
    const lightbox = document.getElementById('imageLightbox');
    const lightboxImg = document.getElementById('lightboxImage');
    lightboxImg.src = imgSrc;
    lightboxImg.dataset.type = type || '';
    lightboxImg.dataset.id = id || '';
    lightbox.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeLightbox() {
    const lightbox = document.getElementById('imageLightbox');
    lightbox.style.display = 'none';
    document.body.style.overflow = 'auto';
}

function deleteLightboxImage() {
    const lightboxImg = document.getElementById('lightboxImage');
    const type = lightboxImg.dataset.type;
    const id = lightboxImg.dataset.id;
    
    if (!type || !id) {
        alert('Cannot delete this image');
        return;
    }
    
    if (confirm('Are you sure you want to delete this image?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        
        if (type === 'post') {
            form.action = '/profile/post/' + id + '/delete';
        } else if (type === 'album') {
            form.action = '/album/' + id + '/delete';
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

function confirmDeleteAccount() {
    if(confirm('‚ö†Ô∏è DELETE ACCOUNT?\n\nThis will permanently delete:\n‚Ä¢ All your posts and comments\n‚Ä¢ All your messages\n‚Ä¢ All your products\n‚Ä¢ All your album photos\n‚Ä¢ All your stories\n‚Ä¢ All your friendships\n‚Ä¢ Your entire account\n\nThis CANNOT be undone!\n\nType "DELETE" to confirm:')) {
        const confirmation = prompt('Type DELETE in capital letters to confirm:');
        if(confirmation === 'DELETE') {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/account/delete';
            document.body.appendChild(form);
            form.submit();
        } else if(confirmation !== null) {
            alert('Account deletion cancelled. Text did not match.');
        }
    }
}

const profileStories = {{ stories | tojson }};
const profileUsername = "{{ user.username }}";
const staticBase = "{{ url_for('static', filename='') }}";
let profileStoryIndex = 0;

function openMyStory(){
    const input = document.getElementById('profileStoryInput');
    if(!profileStories || profileStories.length === 0){
        if(input) input.click();
        return;
    }
    profileStoryIndex = 0;
    showProfileStory();
}

function showProfileStory(){
    const modal = document.getElementById('profileStoryModal');
    const img = document.getElementById('profileStoryImage');
    const pfp = document.getElementById('profileStoryPfp');
    const name = document.getElementById('profileStoryUsername');
    const backBtn = document.getElementById('profileStoryBack');
    const delBtn = document.getElementById('profileStoryDelete');

    if(!modal || !img) return;
    modal.style.display = 'flex';
    document.body.classList.add('profile-story-open');

    let imgPath = profileStories[profileStoryIndex].image || '';
    if (imgPath.startsWith('/static/')) {
        imgPath = imgPath.replace(/^\/?static\//, '/static/');
    } else if (!imgPath.startsWith('/') && !imgPath.startsWith('http')) {
        imgPath = staticBase + imgPath;
    }
    img.src = imgPath;

    if(pfp) {
        const avatarPath = "{{ url_for('static', filename=user.avatar or 'avatars/default.png') }}?t=" + Math.random();
        pfp.src = avatarPath;
    }
    if(name) name.textContent = profileUsername;

    if(backBtn) backBtn.onclick = closeProfileStory;
    if(delBtn) {
        delBtn.onclick = () => {
            const storyId = profileStories[profileStoryIndex].id;
            if(confirm('Delete this story?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/story/' + storyId + '/delete';
                document.body.appendChild(form);
                form.submit();
            }
        };
    }
}

function closeProfileStory(){
    const modal = document.getElementById('profileStoryModal');
    if(modal) modal.style.display = 'none';
    document.body.classList.remove('profile-story-open');
}

function profileNextStory(){
    if(profileStories && profileStoryIndex < profileStories.length - 1){
        profileStoryIndex++;
        showProfileStory();
    }
}
function profilePrevStory(){
    if(profileStories && profileStoryIndex > 0){
        profileStoryIndex--;
        showProfileStory();
    }
}
</script>

</body>
</html>
