<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Subscription</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
.container { display:flex; }
.sidebar { width: 230px; background: var(--card); border-radius: var(--radius); padding:20px; box-shadow: var(--shadow-soft); }
.feed { flex:1; padding:30px; }

.plans { display:grid; grid-template-columns: repeat(3, minmax(220px, 1fr)); gap:18px; }
.plan-card {
    position: relative;
    background: var(--card);
    border-radius: 18px;
    padding: 20px;
    min-height: 260px;
    box-shadow: var(--shadow-soft);
    overflow: hidden;
    cursor: pointer;
    transition: transform .2s ease, box-shadow .2s ease;
}
.plan-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-medium); }
.plan-card::before {
    content: "";
    position: absolute;
    inset: -2px;
    border-radius: 20px;
    background: conic-gradient(from 0deg, #3d5a80, #5c7fa3, #3d5a80);
    animation: spin 6s linear infinite;
    z-index: 0;
}
.plan-card::after {
    content: "";
    position: absolute;
    inset: 2px;
    border-radius: 16px;
    background: var(--card);
    z-index: 1;
}
.plan-content { position: relative; z-index: 2; display:flex; flex-direction:column; gap:10px; }
.plan-title { font-size: 20px; font-weight: 700; color: var(--text); margin:0; }
.plan-price { font-size: 18px; font-weight: 700; color: var(--accent); }
.plan-summary { color: var(--muted); margin:0; }
.plan-details { display:none; color: var(--text); font-size: 14px; line-height:1.4; }
.plan-card.active .plan-details { display:block; }
.plan-actions { display:flex; gap:10px; align-items:center; margin-top: 8px; }
.buy-btn { background: var(--primary-gradient); color:#fff; border:none; padding:8px 14px; border-radius:12px; cursor:pointer; }
.info-btn { background: var(--soft-gradient); color: var(--text); border:none; padding:8px 12px; border-radius:12px; cursor:pointer; }
.alert { padding:14px; border-radius:12px; margin-bottom:20px; text-align:center; }

@keyframes spin {
    to { transform: rotate(360deg); }
}

@media (max-width: 900px) {
    .plans { grid-template-columns: 1fr; }
}

/* Notification badge */
.notification-badge {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 11px;
    font-weight: 700;
    min-width: 20px;
    text-align: center;
    display: inline-block;
}
.sidebar a {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
</style>
</head>
<body>
{% include '_theme_toggle.html' %}

<div class="container">
    <div class="sidebar">
        <h3>Hi {{ session.get('username','User') }}</h3>
        <a href="/forum">Community</a>
        {% if session.user_id == 1 %}
        <a href="/shop">Shop</a>
        <a href="/purchases">My Purchases</a>
        {% endif %}
        <a href="/friends">
            <span>Friends</span>
            {% if friend_requests_count > 0 %}
            <span class="notification-badge">{{ friend_requests_count }}</span>
            {% endif %}
        </a>
        <a href="/messages">
            <span>Messages</span>
            {% if unread_messages_count > 0 %}
            <span class="notification-badge">{{ unread_messages_count }}</span>
            {% endif %}
        </a>
        <a href="/profile">Profile</a>
        <a href="/photos">Photos</a>
        <a href="/dashboard">Dashboard</a>
        <a href="/subscription">Subscription</a>
    </div>
    <div class="feed">
        <h2>Choose Your Plan</h2>
        {% if session.get('email') == 'ho.swag@mail.ru' %}
        <a href="/admin/users" style="display:inline-block;margin-bottom:12px;">Manage users</a>
        {% endif %}
        
        {% if user and user.subscription and user.subscription != 'none' %}
        <div style="background:var(--card);padding:20px;border-radius:18px;margin-bottom:20px;box-shadow:var(--shadow-soft);border:1px solid var(--border-soft);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
                <div>
                    <div style="font-size:14px;color:var(--muted);margin-bottom:6px;">Your Current Plan</div>
                    <div style="font-size:24px;font-weight:700;color:var(--text);text-transform:capitalize;">{{ user.subscription }}</div>
                    {% if subscription_date %}
                    <div style="font-size:13px;color:var(--muted);margin-top:4px;">
                        <i class="fa-solid fa-calendar" style="margin-right:4px;"></i> Active since {{ subscription_date }}
                    </div>
                    {% endif %}
                </div>
                <div style="text-align:right;">
                    {% if user.subscription == 'basic' %}
                    <div style="font-size:20px;font-weight:700;color:var(--accent);">$4/mo</div>
                    {% elif user.subscription == 'pro' %}
                    <div style="font-size:20px;font-weight:700;color:var(--accent);">$12/mo</div>
                    {% elif user.subscription == 'premium' %}
                    <div style="font-size:20px;font-weight:700;color:var(--accent);">$24/mo</div>
                    {% endif %}
                    <div style="font-size:12px;color:var(--muted);margin-top:4px;">Monthly</div>
                </div>
            </div>
            <div style="border-top:1px solid var(--border-soft);padding-top:12px;font-size:13px;color:var(--text);">
                <div style="font-weight:600;margin-bottom:8px;">Your Benefits:</div>
                {% if user.subscription == 'basic' %}
                <div style="color:var(--muted);line-height:1.6;">
                    ✓ Message editing & deletion<br>
                    ✓ Sticker messages<br>
                    ✓ List 1 product in shop
                </div>
                {% elif user.subscription == 'pro' %}
                <div style="color:var(--muted);line-height:1.6;">
                    ✓ All Basic features<br>
                    ✓ Send money in messages<br>
                    ✓ List up to 5 products in shop<br>
                    ✓ Priority support
                </div>
                {% elif user.subscription == 'premium' %}
                <div style="color:var(--muted);line-height:1.6;">
                    ✓ All Pro features<br>
                    ✓ Admin badge<br>
                    ✓ Unlimited products in shop<br>
                    ✓ VIP support
                </div>
                {% endif %}
                <div style="margin-top:16px;display:flex;gap:10px;">
                    <form method="post" action="/subscription/cancel" style="display:inline;">
                        <button type="button" onclick="openConfirmModal('cancel', 'Cancel Subscription?', 'Are you sure you want to cancel your subscription? You will lose access to premium features.')" style="background:#ef4444;color:white;border:none;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:600;flex:1;">Cancel Subscription</button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if session.user_id == 1 %}
        {% if request.args.get('error') == 'insufficient' %}
        <div class="alert" style="background:#ef4444;color:white;">
            Insufficient wallet balance. <a href="/wallet" style="color:white;text-decoration:underline;">Add funds</a>
        </div>
        {% endif %}

        {% if request.args.get('success') == '1' %}
        <div class="alert" style="background:#10b981;color:white;">
            Subscription activated! Enjoy your new features.
        </div>
        {% endif %}
        {% endif %}
        
        <h3 style="margin-top:24px;margin-bottom:16px;color:var(--text);">Available Plans</h3>
        <div class="plans">
            <div class="plan-card" data-plan="basic">
                <div class="plan-content">
                    <p class="plan-title">Basic</p>
                    {% if session.user_id == 1 %}
                    <p class="plan-price">$4 / mo</p>
                    {% else %}
                    <p class="plan-price" style="color:var(--muted);font-size:16px;">Coming Soon</p>
                    {% endif %}
                    <p class="plan-summary">Starter features for casual use.</p>
                    <div class="plan-details">
                        - Access to core community features
                        <br>- Message editing & deletion
                        <br>- Sticker messages
                        <br>- Standard support
                    </div>
                    <div class="plan-actions">
                        <button class="info-btn" type="button">Details</button>
                        {% if session.user_id == 1 %}
                            {% if user and user.subscription == 'basic' %}
                            <span style="background:var(--soft-1);color:var(--text);padding:8px 14px;border-radius:12px;font-weight:600;border:1px solid var(--border);">Current Plan</span>
                            {% else %}
                            <form method="post" action="/subscription/buy/basic" style="display:inline;">
                                <button class="buy-btn" type="submit">Buy Basic</button>
                            </form>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="plan-card" data-plan="pro">
                <div class="plan-content">
                    <p class="plan-title">Pro</p>
                    {% if session.user_id == 1 %}
                    <p class="plan-price">$12 / mo</p>
                    {% else %}
                    <p class="plan-price" style="color:var(--muted);font-size:16px;">Coming Soon</p>
                    {% endif %}
                    <p class="plan-summary">For creators who want more.</p>
                    <div class="plan-details">
                        - Everything in Basic
                        <br>- Send money in messages
                        <br>- Priority support
                        <br>- Advanced features
                    </div>
                    <div class="plan-actions">
                        <button class="info-btn" type="button">Details</button>
                        {% if session.user_id == 1 %}
                            {% if user and user.subscription == 'pro' %}
                            <span style="background:var(--soft-1);color:var(--text);padding:8px 14px;border-radius:12px;font-weight:600;border:1px solid var(--border);">Current Plan</span>
                            {% else %}
                            <form method="post" action="/subscription/buy/pro" style="display:inline;">
                                <button class="buy-btn" type="submit">Buy Pro</button>
                            </form>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="plan-card" data-plan="premium">
                <div class="plan-content">
                    <p class="plan-title">Premium</p>
                    {% if session.user_id == 1 %}
                    <p class="plan-price">$24 / mo</p>
                    {% else %}
                    <p class="plan-price" style="color:var(--muted);font-size:16px;">Coming Soon</p>
                    {% endif %}
                    <p class="plan-summary">All features, best support.</p>
                    <div class="plan-details">
                        - Everything in Pro
                        <br>- Custom username changes
                        <br>- VIP badges
                        <br>- Privacy controls
                        <br>- Early access to features
                    </div>
                    <div class="plan-actions">
                        <button class="info-btn" type="button">Details</button>
                        {% if session.user_id == 1 %}
                            {% if user and user.subscription == 'premium' %}
                            <span style="background:var(--soft-1);color:var(--text);padding:8px 14px;border-radius:12px;font-weight:600;border:1px solid var(--border);">Current Plan</span>
                            {% else %}
                            <form method="post" action="/subscription/buy/premium" style="display:inline;">
                                <button class="buy-btn" type="submit">Buy Premium</button>
                            </form>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CONFIRMATION MODAL -->
<div id="confirmModal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;">
    <div style="background:var(--card);padding:24px;border-radius:18px;width:90%;max-width:400px;box-shadow:var(--shadow-large);">
        <h3 id="confirmTitle" style="margin:0 0 12px 0;color:var(--text);"></h3>
        <p id="confirmMessage" style="color:var(--muted);margin:0 0 24px 0;line-height:1.5;"></p>
        <div style="display:flex;gap:12px;">
            <button onclick="closeConfirmModal()" style="flex:1;background:var(--soft-1);color:var(--text);border:1px solid var(--border-soft);padding:12px;border-radius:12px;cursor:pointer;font-weight:600;">Cancel</button>
            <button id="confirmBtn" onclick="confirmAction()" style="flex:1;background:#10b981;color:white;border:none;padding:12px;border-radius:12px;cursor:pointer;font-weight:600;">Confirm</button>
        </div>
    </div>
</div>

<script>
let pendingAction = null;
let pendingForm = null;

function openConfirmModal(action, title, message) {
    pendingAction = action;
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').textContent = message;
    
    const confirmBtn = document.getElementById('confirmBtn');
    if (action === 'cancel') {
        confirmBtn.style.background = '#ef4444';
    } else if (action === 'buy' || action === 'subscribe') {
        confirmBtn.style.background = '#10b981';
    }
    
    document.getElementById('confirmModal').style.display = 'flex';
}

function closeConfirmModal() {
    document.getElementById('confirmModal').style.display = 'none';
    pendingAction = null;
    pendingForm = null;
}

function confirmAction() {
    if (pendingAction === 'cancel') {
        // Create and submit cancel form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/subscription/cancel';
        document.body.appendChild(form);
        form.submit();
    } else if (pendingAction === 'buy' && pendingForm) {
        pendingForm.submit();
    }
    closeConfirmModal();
}

// Add click handler to all buy buttons
window.addEventListener('load', function() {
    document.querySelectorAll('.buy-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const form = this.closest('form');
            if (form) {
                const action = form.action.split('/').pop();
                let title, message;
                
                if (action === 'basic') {
                    title = 'Buy Basic Plan?';
                    message = 'Upgrade to Basic for $4/mo. Continue?';
                } else if (action === 'pro') {
                    title = 'Buy Pro Plan?';
                    message = 'Upgrade to Pro for $12/mo. Continue?';
                } else if (action === 'premium') {
                    title = 'Buy Premium Plan?';
                    message = 'Upgrade to Premium for $24/mo. Continue?';
                }
                
                if (title) {
                    pendingAction = 'subscribe';
                    pendingForm = form;
                    openConfirmModal(pendingAction, title, message);
                }
            }
        });
    });
});

const cards = document.querySelectorAll('.plan-card');
cards.forEach(card => {
    card.addEventListener('click', (e) => {
        if (e.target.closest('button')) return;
        card.classList.toggle('active');
    });
    const infoBtn = card.querySelector('.info-btn');
    if (infoBtn) {
        infoBtn.addEventListener('click', () => card.classList.toggle('active'));
    }
});
</script>
</body>
</html>
