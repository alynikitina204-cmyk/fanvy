<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shop</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
/* reuse some forum styles for product cards */
.container { display:flex; }
.sidebar { width: 230px; background: var(--card); border-radius: var(--radius); padding:20px; box-shadow: var(--shadow-soft); }
.feed { flex:1; padding:30px; }
.product-form { margin-bottom: 30px; }
.product-card { background: var(--card); border-radius: var(--radius); padding:20px; box-shadow: var(--shadow-soft); margin-bottom:20px; display:flex; gap:20px; }
.product-card img { width:120px; height:120px; object-fit:cover; border-radius:12px; }
.product-info { flex:1; display:flex; flex-direction:column; gap:8px; }
.product-info h3 { margin:0; color: var(--text); }
.product-info p { margin:0; color: var(--muted); }
.product-price { font-weight:700; color: var(--accent); }
.delete-product { background: var(--soft-gradient); color: var(--text); border:none; padding:6px 12px; border-radius:12px; cursor:pointer; }
.delete-product:hover { filter: brightness(0.9); }

/* Notification badge */
.notification-badge {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 11px;
    font-weight: 700;
    min-width: 20px;
    text-align: center;
    display: inline-block;
}
.sidebar a {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
</style>
</head>
<body>
{% include '_theme_toggle.html' %}

<div class="container">
    <div class="sidebar">
        <h3>Hi {{ session.get('username','User') }}</h3>
        <a href="/forum">Community</a>
        {% if session.user_id == 1 %}
        <a href="/shop">Shop</a>
        <a href="/cart">Cart</a>
        <a href="/purchases">My Purchases</a>
        {% endif %}
        <a href="/friends">
            <span>Friends</span>
            {% if friend_requests_count > 0 %}
            <span class="notification-badge">{{ friend_requests_count }}</span>
            {% endif %}
        </a>
        <a href="/messages">
            <span>Messages</span>
            {% if unread_messages_count > 0 %}
            <span class="notification-badge">{{ unread_messages_count }}</span>
            {% endif %}
        </a>
        <a href="/profile">Profile</a>
        <a href="/photos">Photos</a>
        <a href="/dashboard">Dashboard</a>
        <a href="/subscription">Subscription</a>
    </div>
    <div class="feed">
        {% if limit_error %}
        <div style="margin-bottom:12px;padding:10px 12px;border-radius:12px;background:var(--soft-1);color:var(--muted);">
            {% if limit_error == '1' %}
                Basic plan can list only 1 product. <a href="/subscription" style="color:var(--accent);">Upgrade to Pro for 5 products or Premium for unlimited.</a>
            {% elif limit_error == '5' %}
                Pro plan can list up to 5 products. <a href="/subscription" style="color:var(--accent);">Upgrade to Premium for unlimited products.</a>
            {% endif %}
        </div>
        {% endif %}
        <div class="shop-header" style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
            <input id="shopSearch" type="text" placeholder="Search products" value="{{ query }}"
                   style="flex:1;padding:8px;border:2px solid var(--accent);border-radius:12px;font-weight:600;">
            <a href="/cart" class="cart-icon" style="position:relative;font-size:24px;color:var(--text);">
                <i class="fa-solid fa-basket-shopping"></i>
                {% if cart_count %}<span class="badge" style="position:absolute;top:-4px;right:-8px;background:red;color:#fff;border-radius:50%;font-size:10px;padding:2px 5px;">{{ cart_count }}</span>{% endif %}
            </a>
        </div>
        <!-- hidden modal form -->
        <div id="productModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;
            background:rgba(0,0,0,0.5);justify-content:center;align-items:center;">
            <div style="background:var(--card);padding:20px;border-radius:16px;max-width:400px;width:90%;">
                <h3>Add a Product</h3>
                <form method="POST" enctype="multipart/form-data">
                    <input type="text" name="name" placeholder="Product name" required style="width:100%;padding:8px;margin-bottom:8px;">
                    <textarea name="description" placeholder="Description" style="width:100%;padding:8px;margin-bottom:8px;"></textarea>
                    <input type="number" step="0.01" name="price" placeholder="Price" required style="width:100%;padding:8px;margin-bottom:8px;">
                    <label style="display:block;margin-bottom:4px;font-size:14px;">Product type</label>
                    <select name="product_type" style="width:100%;padding:8px;margin-bottom:8px;">
                        <option value="normal">Normal product</option>
                        <option value="sticker">Sticker pack</option>
                    </select>
                    <label style="display:block;margin-bottom:4px;font-size:14px;">Main file (app/extension/music/document)</label>
                    <input type="file" name="main_file" accept="*/*" style="margin-bottom:8px;">
                    <label style="display:block;margin-bottom:4px;font-size:14px;">Product images (up to 5)</label>
                    <input type="file" name="images" accept="image/*" multiple style="margin-bottom:8px;">
                    <button type="submit" class="edit-btn">Post Product</button>
                    <button type="button" onclick="closeProductModal()" style="margin-left:10px;">Cancel</button>
                </form>
            </div>
        </div>
        
        {% for p in products %}
        <a href="/shop/product/{{ p.id }}" style="text-decoration:none;color:inherit;">
        <div class="product-card" style="flex-wrap:wrap;">
            {% if p.images %}
                {% set imgs = p.images.split(',') if p.images else [] %}
                <div style="display:flex;gap:4px;flex-wrap:wrap;max-width:260px;">
                    {% for img in imgs[:3] %}
                        <img src="{{ url_for('static', filename=img) }}" style="width:80px;height:80px;">
                    {% endfor %}
                    {% if imgs|length > 3 %}
                        <span style="align-self:center;color:var(--muted);font-size:12px;">+{{ imgs|length-3 }}</span>
                    {% endif %}
                </div>
            {% else %}
                <div style="width:120px;height:120px;background:var(--soft-1);border-radius:12px;"></div>
            {% endif %}
            <div class="product-info">
                <h3>{{ p.name }}</h3>
                <p>{{ p.description }}</p>
                <span class="product-price">${{ '{:.2f}'.format(p.price or 0) }}</span>
                <small>
                    by {{ p.username }}
                    {% if p.seller_subscription == 'premium' %}
                        <span class="admin-badge">ADMIN</span>
                    {% endif %}
                </small>
                {% if p.file %}
                <div style="margin-top:6px;font-size:12px;color:var(--accent);">
                    <i class="fa-solid fa-file-zipper"></i> Includes downloadable file
                </div>
                {% endif %}
                <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                    {% if p.user_id == session.get('user_id') %}
                    <form method="POST" action="/shop/product/{{ p.id }}/delete">
                        <button class="delete-product">Delete</button>
                    </form>
                    {% else %}
                    <form id="cartForm{{ p.id }}" action="/cart/add/{{ p.id }}">
                        <button type="button" onclick="confirmAddToCart(event, '{{ p.name }}', {{ p.price }})" class="edit-btn" style="font-size:14px;padding:6px 10px;">Add to cart</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        </a>
        {% endfor %}
    </div>
</div>

<button id="openProductBtn" style="position:fixed;bottom:20px;right:20px;background:var(--primary-gradient);color:#fff;border:none;padding:14px 18px;border-radius:50%;font-size:24px;cursor:pointer;box-shadow:var(--shadow-medium);">+</button>

<!-- CONFIRMATION MODAL -->
<div id="confirmModal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000;">
    <div style="background:var(--card);padding:24px;border-radius:18px;width:90%;max-width:400px;box-shadow:var(--shadow-large);">
        <h3 id="confirmTitle" style="margin:0 0 12px 0;color:var(--text);"></h3>
        <p id="confirmMessage" style="color:var(--muted);margin:0 0 24px 0;line-height:1.5;"></p>
        <div style="display:flex;gap:12px;">
            <button onclick="closeConfirmModal()" style="flex:1;background:var(--soft-1);color:var(--text);border:1px solid var(--border-soft);padding:12px;border-radius:12px;cursor:pointer;font-weight:600;">Cancel</button>
            <button id="confirmBtn" onclick="confirmAddCart()" style="flex:1;background:#10b981;color:white;border:none;padding:12px;border-radius:12px;cursor:pointer;font-weight:600;">Add to cart</button>
        </div>
    </div>
</div>

<script>
let pendingCartForm = null;

function confirmAddToCart(e, productName, price) {
    e.preventDefault();
    const form = e.target.closest('form');
    pendingCartForm = form;
    
    document.getElementById('confirmTitle').textContent = 'Add to Cart?';
    document.getElementById('confirmMessage').textContent = `Add "${productName}" ($${price.toFixed(2)}) to your cart?`;
    document.getElementById('confirmModal').style.display = 'flex';
}

function closeConfirmModal() {
    document.getElementById('confirmModal').style.display = 'none';
    pendingCartForm = null;
}

function confirmAddCart() {
    if (pendingCartForm) {
        pendingCartForm.submit();
    }
    closeConfirmModal();
}

// modal handlers
const modal = document.getElementById('productModal');
function closeProductModal(){ if(modal) modal.style.display='none'; }
if(document.getElementById('openProductBtn')){
    document.getElementById('openProductBtn').onclick = () => { if(modal) modal.style.display='flex'; };
}
// close modal when clicking outside form
if(modal){
    modal.addEventListener('click', e => {
        if(e.target === modal) closeProductModal();
    });
}
// search filtering uses server so listen for enter
const searchInput = document.getElementById('shopSearch');
if(searchInput){
    searchInput.addEventListener('keydown', e => { if(e.key==='Enter'){
        const q = encodeURIComponent(searchInput.value.trim());
        window.location.href = '/shop' + (q?('?q='+q):'');
    }});
}
</script>
</body>
</html>